import{j as O}from"./chunk-XRLRB6RL.js";import{A as M,D as m,H as g,a as h,b as v,e as _,f as L,g as u,h as p,ib as b,j as A,jb as C,p as D,q as B,r as I,s as w,ub as $,y as R}from"./chunk-C2MK7UFR.js";var f={production:!0,apiKey:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjODRhMjQ2ODdmZmU3OGYzZGUwM2RkZjRlMTM0NDQyZiIsIm5iZiI6MTc1OTk0NTgxOC4zMDcwMDAyLCJzdWIiOiI2OGU2YTQ1YTEyYWY0MmRlMTU3NjM3MzEiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.nVLI6Ox_SEDWZ6BFp-G03VWON-4ipsuCObdpNxGhfag"};var S=class n{cache=new Map;put(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}clear(){this.cache.clear()}removeByPrefix(e){for(let t of Array.from(this.cache.keys()))t.startsWith(e)&&this.cache.delete(t)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};var y=class n{translocoService=g($);storageKey="tmdb.language";currentLanguageSubject=new _(this.loadInitialLanguage());currentLanguage$=this.currentLanguageSubject.asObservable();constructor(){this.translocoService.setActiveLang(this.getCurrentLanguage())}getCurrentLanguage(){return this.currentLanguageSubject.value}setCurrentLanguage(e){if(!/^[a-z]{2}-[A-Z]{2}$/.test(e))throw new Error(`Invalid language: ${e}`);localStorage.setItem(this.storageKey,e),this.translocoService.setActiveLang(e),this.currentLanguageSubject.next(e)}loadInitialLanguage(){return localStorage.getItem(this.storageKey)??"en-US"}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};var k=class n{http=g(C);baseUrl="https://api.themoviedb.org/3";cache=g(S);local=g(O);languageService=g(y);buildCacheKey(e,t){return t?`${e}?${t.toString()}`:e}constructor(){this.languageService.currentLanguage$.pipe(w(),I(200),R(()=>(this.cache.removeByPrefix(this.baseUrl),this.reloadFavoritesByLanguage$()))).subscribe()}tokenAuthVerify$(){let e=`${this.baseUrl}/authentication`;return this.http.get(e,{headers:{Authorization:f.apiKey}}).pipe(p(t=>t.success===!0),D(()=>u(!1)))}searchMulti(e,t){let i=e.trim();if(!i)return u({page:1,results:[],total_pages:0,total_results:0});let d=t?.language??this.languageService.getCurrentLanguage(),a=new b().set("query",i).set("language",d).set("page",String(t?.page??1)).set("include_adult",String(!!t?.includeAdult)),o=`${this.baseUrl}/search/multi`,r=this.buildCacheKey(o,a),l=this.cache.get(r);return l!==void 0?u(l):this.http.get(o,{headers:{Authorization:f.apiKey,Accept:"application/json"},params:a}).pipe(M(s=>this.cache.put(r,s)))}mapMultiSearchToResult(e){return e.filter(this.isMovieOrTv).map(this.mapResultToView)}getMediasByType(e,t=1,i=20,d){let a=`${this.baseUrl}/${e}/${d}`,o=new b().set("language",this.languageService.getCurrentLanguage()).set("page",String(t)),r=this.buildCacheKey(a,o),l=this.cache.get(r);if(l!==void 0){let s=new Set(this.local.getFavoritesSnapshot().map(c=>c.id));return u(l.slice(0,i).map(c=>v(h({},c),{favorite:s.has(c.id)})))}return this.http.get(a,{headers:{Authorization:f.apiKey},params:o}).pipe(p(s=>s.results.map(c=>this.mapMediaDetailsFromList(c,e))),M(s=>this.cache.put(r,s)),p(s=>s.slice(0,i)),p(s=>{let c=new Set(this.local.getFavoritesSnapshot().map(T=>T.id));return s.map(T=>v(h({},T),{favorite:c.has(T.id)}))}))}getMediaDetailsByID(e,t){let i=`${this.baseUrl}/${e}/${t}`,d=new b().set("append_to_response","videos,credits").set("language",this.languageService.getCurrentLanguage()),a=this.buildCacheKey(i,d),o=this.cache.get(a);if(o!==void 0){let r=new Set(this.local.getFavoritesSnapshot().map(l=>l.id));return u(v(h({},o),{favorite:r.has(o.id)}))}return this.http.get(i,{headers:{Authorization:f.apiKey},params:d}).pipe(p(r=>this.mapMediaDetailsFromDetails(r,e)),M(r=>this.cache.put(a,r)),p(r=>{let l=new Set(this.local.getFavoritesSnapshot().map(s=>s.id));return v(h({},r),{favorite:l.has(r.id)})}))}reloadFavoritesByLanguage$(){let e=this.local.getFavoritesSnapshot();if(e.length===0)return u(void 0);let t=new Map(e.map(a=>[`${a.mediaType}:${a.id}`,a])),i=Array.from(t.values());return L(i).pipe(A(a=>this.getMediaDetailsByID(a.mediaType,a.id).pipe(D(()=>u(v(h({},a),{favorite:!0})))),5),B(),M(a=>{this.local.setFavorites(a)}),p(()=>{}))}isMovieOrTv=e=>e.media_type==="movie"||e.media_type==="tv";mapResultToView=e=>e.media_type==="movie"?{id:e.id,mediaType:"movie",title:e.title,subtitle:e.release_date??null,posterUrl:this.buildPosterUrl("w92",e.poster_path),routerLink:["/","movie","details",String(e.id)]}:{id:e.id,mediaType:"tv",title:e.name,subtitle:e.first_air_date??null,posterUrl:this.buildPosterUrl("w92",e.poster_path),routerLink:["/","tv","details",String(e.id)]};mapMediaDetailsFromList(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{mediaType:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:this.buildPosterUrl("w500",e.poster_path),release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview}}mapMediaDetailsFromDetails(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{mediaType:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:this.buildPosterUrl("w500",e.poster_path),release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview,backdrop_path:e.backdrop_path,genres:e.genres,status:e.status,tagline:e.tagline,runtime:e.runtime??null,episode_run_time:e.episode_run_time,number_of_seasons:e.number_of_seasons,number_of_episodes:e.number_of_episodes,belongs_to_collection:e.belongs_to_collection,vote_count:e.vote_count,credits:e.credits,videos:e.videos}}buildPosterUrl(e,t){return t?`https://image.tmdb.org/t/p/${e}/${t}`:null}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{y as a,k as b};
