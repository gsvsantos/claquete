import{j as O}from"./chunk-WHWL7PKT.js";import{A as f,D as M,H as v,a as o,b as l,e as y,f as B,g as h,h as g,ib as _,j as A,jb as C,p as D,q as L,r as I,s as w,tb as k,y as R}from"./chunk-25JCDCCY.js";var $=(t=>(t.Movie="movie",t.TV="tv",t))($||{});var b={production:!0,apiKey:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjODRhMjQ2ODdmZmU3OGYzZGUwM2RkZjRlMTM0NDQyZiIsIm5iZiI6MTc1OTk0NTgxOC4zMDcwMDAyLCJzdWIiOiI2OGU2YTQ1YTEyYWY0MmRlMTU3NjM3MzEiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.nVLI6Ox_SEDWZ6BFp-G03VWON-4ipsuCObdpNxGhfag"};var T=class p{cache=new Map;put(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}clear(){this.cache.clear()}removeByPrefix(e){for(let t of Array.from(this.cache.keys()))t.startsWith(e)&&this.cache.delete(t)}static \u0275fac=function(t){return new(t||p)};static \u0275prov=M({token:p,factory:p.\u0275fac,providedIn:"root"})};var S=class p{translocoService=v(k);storageKey="tmdb.language";currentLanguageSubject=new y(this.loadInitialLanguage());currentLanguage$=this.currentLanguageSubject.asObservable();constructor(){this.translocoService.setActiveLang(this.getCurrentLanguage())}getCurrentLanguage(){return this.currentLanguageSubject.value}setCurrentLanguage(e){if(!/^[a-z]{2}-[A-Z]{2}$/.test(e))throw new Error(`Invalid language: ${e}`);localStorage.setItem(this.storageKey,e),this.translocoService.setActiveLang(e),this.currentLanguageSubject.next(e)}loadInitialLanguage(){return localStorage.getItem(this.storageKey)??"en-US"}static \u0275fac=function(t){return new(t||p)};static \u0275prov=M({token:p,factory:p.\u0275fac,providedIn:"root"})};var x=class p{http=v(C);baseUrl="https://api.themoviedb.org/3";cache=v(T);local=v(O);languageService=v(S);buildCacheKey(e,t){return t?`${e}?${t.toString()}`:e}constructor(){this.languageService.currentLanguage$.pipe(w(),I(200),R(()=>(this.cache.removeByPrefix(this.baseUrl),this.reloadFavoritesByLanguage$()))).subscribe()}tokenAuthVerify$(){let e=`${this.baseUrl}/authentication`;return this.http.get(e,{headers:{Authorization:b.apiKey}}).pipe(g(t=>t.success===!0),D(()=>h(!1)))}searchMulti(e,t){let i=e.trim();if(!i)return h({page:1,results:[],total_pages:0,total_results:0});let m=t?.language??this.languageService.getCurrentLanguage(),a=new _().set("query",i).set("language",m).set("page",String(t?.page??1)).set("include_adult",String(!!t?.includeAdult)),c=`${this.baseUrl}/search/multi`,n=this.buildCacheKey(c,a),u=this.cache.get(n);if(u!==void 0){let r=new Set(this.local.getFavoritesSnapshot().map(s=>s.id));return h(l(o({},u),{results:u.results.map(s=>l(o({},s),{favorite:r.has(s.id)}))}))}return this.http.get(c,{headers:{Authorization:b.apiKey,Accept:"application/json"},params:a}).pipe(g(r=>{let s=new Set(this.local.getFavoritesSnapshot().map(d=>d.id));return l(o({},r),{results:r.results.map(d=>l(o({},d),{favorite:s.has(d.id)}))})}),f(r=>this.cache.put(n,r)))}mapMediasSearchResult(e){return l(o({},e),{results:e.results.map(t=>t.media_type==="movie"?l(o({},t),{media_type:"movie",routerLink:["/","movie","details",String(t.id)],vote_average:t.vote_average,poster_path:this.buildPosterUrl("w500",t.poster_path)}):l(o({},t),{media_type:"tv",routerLink:["/","tv","details",String(t.id)],vote_average:t.vote_average,poster_path:this.buildPosterUrl("w500",t.poster_path)}))})}mapMultiSearchToResult(e){return e.filter(this.isMovieOrTv).map(this.mapResultToView)}getMediasByType(e,t=1,i=20,m){let a=`${this.baseUrl}/${e}/${m}`,c=new _().set("language",this.languageService.getCurrentLanguage()).set("page",String(t)),n=this.buildCacheKey(a,c),u=this.cache.get(n);if(u!==void 0){let r=new Set(this.local.getFavoritesSnapshot().map(s=>s.id));return h(u.slice(0,i).map(s=>l(o({},s),{favorite:r.has(s.id)})))}return this.http.get(a,{headers:{Authorization:b.apiKey},params:c}).pipe(g(r=>r.results.map(s=>this.mapMediaDetailsFromList(s,e))),f(r=>this.cache.put(n,r)),g(r=>r.slice(0,i)),g(r=>{let s=new Set(this.local.getFavoritesSnapshot().map(d=>d.id));return r.map(d=>l(o({},d),{favorite:s.has(d.id)}))}))}getMediaDetailsByID(e,t){let i=`${this.baseUrl}/${e}/${t}`,m=new _().set("append_to_response","videos,credits").set("language",this.languageService.getCurrentLanguage()),a=this.buildCacheKey(i,m),c=this.cache.get(a);if(c!==void 0){let n=new Set(this.local.getFavoritesSnapshot().map(u=>u.id));return h(l(o({},c),{favorite:n.has(c.id)}))}return this.http.get(i,{headers:{Authorization:b.apiKey},params:m}).pipe(g(n=>this.mapMediaDetailsFromDetails(n,e)),f(n=>this.cache.put(a,n)),g(n=>{let u=new Set(this.local.getFavoritesSnapshot().map(r=>r.id));return l(o({},n),{favorite:u.has(n.id)})}))}reloadFavoritesByLanguage$(){let e=this.local.getFavoritesSnapshot();if(e.length===0)return h(void 0);let t=new Map(e.map(a=>[`${a.media_type}:${a.id}`,a])),i=Array.from(t.values());return B(i).pipe(A(a=>this.getMediaDetailsByID(a.media_type,a.id).pipe(D(()=>h(l(o({},a),{favorite:!0})))),5),L(),f(a=>{this.local.setFavorites(a)}),g(()=>{}))}isMovieOrTv=e=>e.media_type==="movie"||e.media_type==="tv";mapResultToView=e=>e.media_type==="movie"?{id:e.id,mediaType:"movie",title:e.title,subtitle:e.release_date??null,posterUrl:this.buildPosterUrl("w92",e.poster_path),routerLink:["/","movie","details",String(e.id)]}:{id:e.id,mediaType:"tv",title:e.name,subtitle:e.first_air_date??null,posterUrl:this.buildPosterUrl("w92",e.poster_path),routerLink:["/","tv","details",String(e.id)]};mapMediaDetailsFromList(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{media_type:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:this.buildPosterUrl("w500",e.poster_path),release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview}}mapMediaDetailsFromDetails(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{media_type:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:this.buildPosterUrl("w500",e.poster_path),release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview,backdrop_path:e.backdrop_path,genres:e.genres,status:e.status,tagline:e.tagline,runtime:e.runtime??null,episode_run_time:e.episode_run_time,number_of_seasons:e.number_of_seasons,number_of_episodes:e.number_of_episodes,belongs_to_collection:e.belongs_to_collection,vote_count:e.vote_count,credits:e.credits,videos:e.videos}}buildPosterUrl(e,t){return t?`https://image.tmdb.org/t/p/${e}/${t}`:null}static \u0275fac=function(t){return new(t||p)};static \u0275prov=M({token:p,factory:p.\u0275fac,providedIn:"root"})};export{$ as a,S as b,x as c};
