import{j as O}from"./chunk-QYSTF4DA.js";import{A as m,D as g,H as d,a as h,b as v,e as _,f as L,g as c,h as u,hb as T,ib as C,j as A,p as D,q as B,r as I,s as R,tb as $,y as w}from"./chunk-HUFLTYHU.js";var M={production:!0,apiKey:"Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjODRhMjQ2ODdmZmU3OGYzZGUwM2RkZjRlMTM0NDQyZiIsIm5iZiI6MTc1OTk0NTgxOC4zMDcwMDAyLCJzdWIiOiI2OGU2YTQ1YTEyYWY0MmRlMTU3NjM3MzEiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.nVLI6Ox_SEDWZ6BFp-G03VWON-4ipsuCObdpNxGhfag"};var b=class s{cache=new Map;put(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}clear(){this.cache.clear()}removeByPrefix(e){for(let t of Array.from(this.cache.keys()))t.startsWith(e)&&this.cache.delete(t)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};var y=class s{translocoService=d($);storageKey="tmdb.language";currentLanguageSubject=new _(this.loadInitialLanguage());currentLanguage$=this.currentLanguageSubject.asObservable();constructor(){this.translocoService.setActiveLang(this.getCurrentLanguage())}getCurrentLanguage(){return this.currentLanguageSubject.value}setCurrentLanguage(e){if(!/^[a-z]{2}-[A-Z]{2}$/.test(e))throw new Error(`Invalid language: ${e}`);localStorage.setItem(this.storageKey,e),this.translocoService.setActiveLang(e),this.currentLanguageSubject.next(e)}loadInitialLanguage(){return localStorage.getItem(this.storageKey)??"en-US"}static \u0275fac=function(t){return new(t||s)};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};var U=class s{http=d(C);baseUrl="https://api.themoviedb.org/3";cache=d(b);local=d(O);languageService=d(y);buildCacheKey(e,t){return t?`${e}?${t.toString()}`:e}constructor(){this.languageService.currentLanguage$.pipe(R(),I(200),w(()=>(this.cache.removeByPrefix(this.baseUrl),this.reloadFavoritesByLanguage$()))).subscribe()}tokenAuthVerify$(){let e=`${this.baseUrl}/authentication`;return this.http.get(e,{headers:{Authorization:M.apiKey}}).pipe(u(t=>t.success===!0),D(()=>c(!1)))}searchMulti(e,t){let i=e.trim();if(!i)return c({page:1,results:[],total_pages:0,total_results:0});let p=t?.language??this.languageService.getCurrentLanguage(),a=new T().set("query",i).set("language",p).set("page",String(t?.page??1)).set("include_adult",String(!!t?.includeAdult)),o=`${this.baseUrl}/search/multi`,r=this.buildCacheKey(o,a),l=this.cache.get(r);return l!==void 0?c(l):this.http.get(o,{headers:{Authorization:M.apiKey,Accept:"application/json"},params:a}).pipe(m(n=>this.cache.put(r,n)))}mapMultiSearchToResult(e){return e.filter(this.isMovieOrTv).map(this.mapResultToView)}getMediasByType(e,t=1,i=20,p){let a=`${this.baseUrl}/${e}/${p}`,o=new T().set("language",this.languageService.getCurrentLanguage()).set("page",String(t)),r=this.buildCacheKey(a,o),l=this.cache.get(r);return l!==void 0?c(l.slice(0,i)):this.http.get(a,{headers:{Authorization:M.apiKey},params:o}).pipe(u(n=>n.results.map(S=>this.mapMediaDetailsFromList(S,e))),m(n=>this.cache.put(r,n)),u(n=>n.slice(0,i)),u(n=>{let S=new Set(this.local.getFavoritesSnapshot().map(f=>f.id));return n.map(f=>v(h({},f),{favorite:S.has(f.id)}))}))}getMediaDetailsByID(e,t){let i=`${this.baseUrl}/${e}/${t}`,p=new T().set("append_to_response","videos,credits").set("language",this.languageService.getCurrentLanguage()),a=this.buildCacheKey(i,p),o=this.cache.get(a);if(o!==void 0){let r=new Set(this.local.getFavoritesSnapshot().map(l=>l.id));return c(v(h({},o),{favorite:r.has(o.id)}))}return this.http.get(i,{headers:{Authorization:M.apiKey},params:p}).pipe(u(r=>this.mapMediaDetailsFromDetails(r,e)),m(r=>this.cache.put(a,r)),u(r=>{let l=new Set(this.local.getFavoritesSnapshot().map(n=>n.id));return v(h({},r),{favorite:l.has(r.id)})}))}reloadFavoritesByLanguage$(){let e=this.local.getFavoritesSnapshot();if(e.length===0)return c(void 0);let t=new Map(e.map(a=>[`${a.mediaType}:${a.id}`,a])),i=Array.from(t.values());return L(i).pipe(A(a=>this.getMediaDetailsByID(a.mediaType,a.id).pipe(D(()=>c(v(h({},a),{favorite:!0})))),5),B(),m(a=>{this.local.setFavorites(a)}),u(()=>{}))}isMovieOrTv=e=>e.media_type==="movie"||e.media_type==="tv";mapResultToView=e=>e.media_type==="movie"?{id:e.id,mediaType:"movie",title:e.title,subtitle:e.release_date??null,posterUrl:this.buildPosterUrl(e.poster_path),routerLink:["/","movie","details",String(e.id)]}:{id:e.id,mediaType:"tv",title:e.name,subtitle:e.first_air_date??null,posterUrl:this.buildPosterUrl(e.poster_path),routerLink:["/","tv","details",String(e.id)]};buildPosterUrl(e){return e?`https://image.tmdb.org/t/p/w92/${e}`:null}mapMediaDetailsFromList(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{mediaType:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:e.poster_path,release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview}}mapMediaDetailsFromDetails(e,t){let i=[""];return t==="movie"?i=["/","movie","details",String(e.id)]:i=["/","tv","details",String(e.id)],{mediaType:t,routerLink:i,favorite:!1,id:e.id,title:e.title,name:e.name,poster_path:e.poster_path,release_date:e.release_date??null,first_air_date:e.first_air_date??null,vote_average:e.vote_average,overview:e.overview,backdrop_path:e.backdrop_path,genres:e.genres,status:e.status,tagline:e.tagline,runtime:e.runtime??null,episode_run_time:e.episode_run_time,number_of_seasons:e.number_of_seasons,number_of_episodes:e.number_of_episodes,belongs_to_collection:e.belongs_to_collection,vote_count:e.vote_count,credits:e.credits,videos:e.videos}}static \u0275fac=function(t){return new(t||s)};static \u0275prov=g({token:s,factory:s.\u0275fac,providedIn:"root"})};export{y as a,U as b};
